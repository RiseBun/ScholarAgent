# 修复ScholarAgent的核心问题并实现学术权重重排序架构

## 问题分析

**当前错误**：
- `TypeError: '<=' not supported between instances of 'int' and 'str'`
- 发生在 `_search_arxiv` 方法中，当比较 `start_year <= paper["year"] <= end_year` 时
- 原因：`paper["year"]` 可能是字符串类型，而 `start_year` 和 `end_year` 是整数类型

**用户建议**：
1. 将 OpenReview 的知识也放进来
2. 转向 "学术权重重排序（Academic Re-ranking）" 架构
3. 实现混合数据源与多维权重模型
4. 使用 LLM 驱动的 "语义改写" 与 "意图识别"
5. 实现搜索结果的 "两阶段重排"

## 修复计划

### 1. 修复类型错误
- **修改位置**：`backend/search_engine.py` 中的 `_search_arxiv` 方法
- **具体修改**：在比较年份之前，确保 `paper["year"]` 是整数类型

### 2. 实现学术权重重排序架构
- **修改位置**：
  - `backend/search_engine.py` - 核心搜索逻辑
  - `backend/tagger.py` - 论文标注
  - `pages/1_🔍_Search.py` - 结果显示

- **具体改进**：
  
  **a. 混合数据源与多维权重模型**
  - 接入 OpenReview API（如果可行）
  - 实现质量评分模型：`Score = (Relevance × w_r) + (Citation × w_c) + (Venue × w_v) + (Recency × w_t)`
  - 建立 Top_Venues 列表，对顶会论文赋予高权重
  - 实现时间衰减函数，确保关注热点论文

  **b. LLM 驱动的"语义改写"与"意图识别"**
  - 扩展 `QueryExpander` 功能，生成核心词、扩展词和约束词
  - 实现负向过滤，剔除不相关内容
  - 同时向多个数据源发送查询

  **c. 搜索结果的"两阶段重排"**
  - 第一阶段（粗排）：API 返回 100-200 篇论文
  - 第二阶段（精排）：使用 LLM 对 top 50 论文进行重排序
  - 实现资深审稿人视角的论文选择

### 3. 改进 CVPR 论文识别
- 增强 venue 字段的提取和识别
- 改进从 comments 字段中提取会议信息的逻辑
- 对 OpenAlex 结果进行更精确的 venue 过滤

## 具体修改步骤

### 步骤1：修复类型错误
```python
# 修改前
if paper.get("year") and start_year <= paper["year"] <= end_year:

# 修改后
if paper.get("year"):
    try:
        paper_year = int(paper["year"])
        if start_year <= paper_year <= end_year:
            papers.append(paper)
    except (ValueError, TypeError):
        # Skip papers with invalid year
        pass
```

### 步骤2：实现学术权重重排序
- 添加 `calculate_paper_score` 方法
- 修改搜索结果排序逻辑
- 实现两阶段重排机制

### 步骤3：改进数据源和意图识别
- 扩展查询扩展功能
- 实现多数据源集成
- 增强论文质量评估

## 预期效果

修复后，ScholarAgent 将：
1. 不再出现类型错误，能够正常处理年份比较
2. 实现学术权重重排序，提供更高质量的论文推荐
3. 更准确地识别 CVPR 等顶会论文
4. 提供更智能的搜索体验，超越传统的关键词检索
5. 成为一个真正"高质量、有意义"的论文引擎